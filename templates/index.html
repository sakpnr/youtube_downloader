<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Video İndirici</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            max-width: 800px;
            margin-top: 50px;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        .card-header {
            background-color: #ff0000;
            color: white;
            border-radius: 15px 15px 0 0 !important;
        }
        .progress {
            height: 25px;
            border-radius: 12px;
        }
        #downloadBtn {
            background-color: #ff0000;
            border: none;
        }
        #downloadBtn:hover {
            background-color: #cc0000;
        }
        .format-card {
            cursor: pointer;
            transition: all 0.3s;
        }
        .format-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .format-card.selected {
            border: 2px solid #ff0000;
        }
        #videoInfo {
            display: none;
        }
        .thumbnail {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="card-header text-center py-3">
                <h2 class="mb-0">YouTube Video İndirici</h2>
            </div>
            <div class="card-body p-4">
                <div class="mb-4">
                    <label for="url" class="form-label">Video URL'si</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="url" placeholder="https://www.youtube.com/watch?v=...">
                        <button class="btn btn-outline-secondary" type="button" id="checkUrl">Kontrol Et</button>
                    </div>
                </div>

                <div id="videoInfo" class="mb-4">
                    <div class="row">
                        <div class="col-md-4">
                            <img id="thumbnail" class="thumbnail mb-3" src="" alt="Video thumbnail">
                        </div>
                        <div class="col-md-8">
                            <h4 id="title" class="mb-2"></h4>
                            <p id="duration" class="text-muted"></p>
                            <div class="mb-3">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="downloadType" id="videoType" value="video" checked>
                                    <label class="form-check-label" for="videoType">Video</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="downloadType" id="audioType" value="audio">
                                    <label class="form-check-label" for="audioType">Ses (MP3)</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="formatList" class="row g-3 mt-2"></div>

                    <div class="mt-4">
                        <label for="downloadPath" class="form-label">İndirme Konumu</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="downloadPath" readonly>
                            <button class="btn btn-outline-secondary" type="button" id="selectFolder">Konum Seç</button>
                        </div>
                    </div>

                    <div class="mt-4">
                        <button id="downloadBtn" class="btn btn-primary w-100" disabled>İndir</button>
                    </div>

                    <div class="mt-4" id="progressContainer" style="display: none;">
                        <div class="progress">
                            <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div id="progressText" class="text-center mt-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
    <script>
        const socket = io();
        let selectedFormat = null;

        socket.on('download_progress', function(data) {
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            progressContainer.style.display = 'block';
            
            if (data.percentage >= 0) {
                progressBar.style.width = data.percentage + '%';
                progressBar.setAttribute('aria-valuenow', data.percentage);
                progressText.textContent = `İndiriliyor: ${data.percentage.toFixed(1)}%`;
            } else {
                progressText.textContent = `İndiriliyor: ${data.downloaded.toFixed(1)} MB`;
            }
        });

        document.getElementById('checkUrl').addEventListener('click', async function() {
            const url = document.getElementById('url').value;
            const downloadType = document.querySelector('input[name="downloadType"]:checked').value;
            
            if (!url) {
                alert('Lütfen bir URL girin!');
                return;
            }

            try {
                const response = await fetch('/get-formats', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        url: url,
                        type: downloadType
                    })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('videoInfo').style.display = 'block';
                    document.getElementById('title').textContent = data.title;
                    document.getElementById('thumbnail').src = data.thumbnail;
                    
                    const duration = Math.floor(data.duration / 60) + ':' + 
                                   String(data.duration % 60).padStart(2, '0');
                    document.getElementById('duration').textContent = `Süre: ${duration}`;

                    const formatList = document.getElementById('formatList');
                    formatList.innerHTML = '';

                    data.formats.forEach(format => {
                        const col = document.createElement('div');
                        col.className = 'col-md-4';

                        const card = document.createElement('div');
                        card.className = 'card format-card h-100';
                        card.onclick = () => selectFormat(format);

                        const cardBody = document.createElement('div');
                        cardBody.className = 'card-body';

                        const quality = downloadType === 'audio' ? 
                            `${format.quality}kbps` : format.quality;
                        const filesize = format.filesize ? 
                            `(${(format.filesize / 1024 / 1024).toFixed(1)} MB)` : '';

                        cardBody.innerHTML = `
                            <h5 class="card-title">${quality}</h5>
                            <p class="card-text">${filesize}</p>
                        `;

                        card.appendChild(cardBody);
                        col.appendChild(card);
                        formatList.appendChild(col);
                    });

                    document.getElementById('downloadBtn').disabled = true;
                } else {
                    alert(data.message);
                }
            } catch (error) {
                alert('Bir hata oluştu: ' + error.message);
            }
        });

        function selectFormat(format) {
            selectedFormat = format;
            
            document.querySelectorAll('.format-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            event.currentTarget.classList.add('selected');
            document.getElementById('downloadBtn').disabled = false;
        }

        document.getElementById('selectFolder').addEventListener('click', async function() {
            try {
                const response = await fetch('/select-folder', {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('downloadPath').value = data.path;
                } else {
                    alert(data.message);
                }
            } catch (error) {
                alert('Bir hata oluştu: ' + error.message);
            }
        });

        document.getElementById('downloadBtn').addEventListener('click', async function() {
            if (!selectedFormat) {
                alert('Lütfen bir format seçin!');
                return;
            }

            const url = document.getElementById('url').value;
            const downloadType = document.querySelector('input[name="downloadType"]:checked').value;
            const downloadPath = document.getElementById('downloadPath').value;

            if (!downloadPath) {
                alert('Lütfen önce indirme konumunu seçin!');
                return;
            }

            try {
                const response = await fetch('/download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        url: url,
                        format_id: selectedFormat.format_id,
                        type: downloadType,
                        download_path: downloadPath || 'downloads'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    document.getElementById('progressContainer').style.display = 'none';
                } else {
                    alert(data.message);
                }
            } catch (error) {
                alert('Bir hata oluştu: ' + error.message);
            }
        });

        document.querySelectorAll('input[name="downloadType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.getElementById('checkUrl').click();
            });
        });
    </script>
</body>
</html> 